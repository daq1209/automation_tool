# Supabase Schema Verification Report

> **Generated:** 2026-01-21  
> **Status:** ⚠️ MIGRATION REQUIRED

---

## Current Supabase Schema

### Table: `admin_users`
```sql
CREATE TABLE admin_users (
    id BIGINT PRIMARY KEY,
    username TEXT NOT NULL,
    password TEXT,          -- ⚠️ PLAINTEXT - INSECURE
    name TEXT
);
```

**Columns:**
- `id` (bigint) - Primary key
- `username` (text) - Login username
- `password` (text) - **⚠️ PLAINTEXT PASSWORD - CRITICAL SECURITY ISSUE**
- `name` (text) - Display name

**Issues:**
- ❌ Missing `password_hash` column required by new code
- ❌ Passwords stored in plaintext (critical security vulnerability)

---

### Table: `woo_sites`
```sql
CREATE TABLE woo_sites (
    id BIGINT PRIMARY KEY,
    created_at TIMESTAMP WITH TIME ZONE,
    site_name TEXT,
    domain_url TEXT,
    secret_key TEXT,
    api_namespace TEXT,
    is_active BOOLEAN,
    google_sheet_id TEXT,
    main_tab_name TEXT,
    consumer_key TEXT,
    consumer_secret TEXT
);
```

**Status:** ✅ Compatible with current code

---

### Table: `profiles`
```sql
CREATE TABLE profiles (
    id UUID PRIMARY KEY,
    email TEXT,
    full_name TEXT,
    role TEXT,
    updated_at TIMESTAMP WITH TIME ZONE
);
```

**Status:** ℹ️ Not used in current codebase

---

## Code Compatibility Check

### ✅ `woo_sites` Usage
**File:** `src/repositories/db.py`

```python
def get_all_sites():
    res = supabase.table('woo_sites').select("*").order('id').execute()
```

**Columns Used:**
- `site_name` ✅
- `domain_url` ✅
- `secret_key` ✅
- `google_sheet_id` ✅
- `main_tab_name` ✅
- `is_active` ✅

**Verdict:** ✅ Fully compatible

---

### ⚠️ `admin_users` Usage
**File:** `src/repositories/db.py` (Updated version)

```python
def check_admin_login(username, password):
    res = supabase.table('admin_users')\
        .select('username, password, password_hash')\  # ← Expects password_hash
        .eq('username', username).execute()
```

**Columns Used:**
- `username` ✅
- `password` ✅ (fallback for migration)
- `password_hash` ❌ **DOES NOT EXIST IN SCHEMA**

**Verdict:** ⚠️ **MIGRATION REQUIRED**

---

## Required Migration Steps

### 1. Add `password_hash` Column
```sql
ALTER TABLE admin_users ADD COLUMN password_hash TEXT;
```

### 2. Generate Hashes
```bash
python generate_password_hash.py
```

### 3. Update Records
For each admin user:
```sql
UPDATE admin_users 
SET password_hash = '$2b$12$YOUR_GENERATED_HASH_HERE' 
WHERE username = 'your_username';
```

### 4. Test Login
- Login with hashed password users
- Old plaintext users should still work (fallback)

### 5. Deprecate Plaintext (Optional)
After all users migrated:
```sql
-- Remove plaintext passwords
UPDATE admin_users 
SET password = NULL 
WHERE password_hash IS NOT NULL;

-- Or drop the column entirely (DANGEROUS - backup first!)
-- ALTER TABLE admin_users DROP COLUMN password;
```

---

## Migration Example

**Before:**
```sql
SELECT * FROM admin_users;
```
```
| id | username | password  | name       | password_hash |
|----|----------|-----------|------------|---------------|
| 1  | admin    | admin123  | Admin User | NULL          |
```

**After Migration:**
```sql
SELECT * FROM admin_users;
```
```
| id | username | password  | name       | password_hash                                        |
|----|----------|-----------|------------|------------------------------------------------------|
| 1  | admin    | admin123  | Admin User | $2b$12$rGkX... (bcrypt hash)                          |
```

**After Cleanup (Recommended):**
```sql
SELECT * FROM admin_users;
```
```
| id | username | password | name       | password_hash                                        |
|----|----------|----------|------------|------------------------------------------------------|
| 1  | admin    | NULL     | Admin User | $2b$12$rGkX... (bcrypt hash)                          |
```

---

## Rollback Plan

If migration fails, reactivate plaintext login by commenting out bcrypt check in `db.py`:

```python
# Temporarily disable bcrypt for emergency access
# if user_data.get('password_hash'):
#     ... bcrypt logic ...

# Use plaintext temporarily
if user_data.get('password'):
    return user_data['password'] == password
```

---

## Security Recommendations

1. **Immediate:** Run migration to add `password_hash` column
2. **Within 1 week:** Hash all passwords
3. **Within 2 weeks:** Remove plaintext passwords
4. **Best Practice:** Enable Row Level Security (RLS) on `admin_users` table

```sql
-- Enable RLS
ALTER TABLE admin_users ENABLE ROW LEVEL SECURITY;

-- Create policy (example)
CREATE POLICY "Users can only read own data" 
ON admin_users FOR SELECT 
USING (auth.uid() = id::text);
```

---

*Report generated by POD Automation System Analyzer*
